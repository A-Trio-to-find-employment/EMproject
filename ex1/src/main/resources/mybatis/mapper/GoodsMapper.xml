<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
<mapper namespace="com.example.demo.mapper.GoodsMapper">
	<select id="getGoodsList" parameterType="StartEnd" resultType="Book">
		select isbn, book_title, authors, publisher, price, stock
		from(select rownum rn, a.*
			from (select isbn, book_title, 
				(SELECT LISTAGG(author, ', ') WITHIN GROUP (ORDER BY author) 
		 		FROM book_author 
		 		WHERE isbn = book.isbn) AS authors, publisher, price, stock
		 		from book) a)
				where rn > #{start} and rn <![CDATA[<]]> #{end}
	</select>
	<select id="getGoodsDetail" parameterType="java.lang.Long" resultType="Book">
		select image_name, isbn, book_title, 
		(SELECT LISTAGG(author, ', ') WITHIN GROUP (ORDER BY author) 
 		FROM book_author 
 		WHERE isbn = book.isbn) AS authors, publisher, cat_id, price, stock
 		from book where isbn Ôºù #{isbn, jdbcType=BIGINT}
	</select>
	<select id="getGoodsCount" resultType="Integer">
		select count(*) from book
	</select>
	<select id="getGoodsByName" parameterType="StartEnd" resultType="Book">
		select isbn, book_title, authors, publisher, price, stock
		from(select rownum rn, a.*
			from (select isbn, book_title, 
				(SELECT LISTAGG(author, ', ') WITHIN GROUP (ORDER BY author) 
		 		FROM book_author 
		 		WHERE isbn = book.isbn) AS authors, publisher, price, stock
		 		from book where book_title like '%' || #{title} || '%') a )
				where rn > #{start} and rn <![CDATA[<]]> #{end}
	</select>
	<update id="updateStock" parameterType="java.lang.Long">
		update book set stock=#{stock} where isbn = #{isbn}
	</update>
	<update id="updateGoods" parameterType="Book">
		update book set image_name=#{image_name}, isbn=#{isbn}, book_title=#{book_title}, 
				(SELECT LISTAGG(author, ', ') WITHIN GROUP (ORDER BY author) 
		 		FROM book_author 
		 		WHERE isbn = book.isbn) AS authors=#{authors}, publisher=#{publisher},
		 		 cat_id=#{cat_id}, price=#{price}
	</update>
	<select id="getIsbnDup" parameterType="java.lang.Long" resultType="Integer">
		select count(*) from book where where isbn=#{isbn}
	</select>
	<insert id="addGoods" parameterType="Book">
		insert into book values(#{image_name}, #{isbn}, #{book_title}, 
				(SELECT LISTAGG(author, ', ') WITHIN GROUP (ORDER BY author) 
		 		FROM book_author 
		 		WHERE isbn = book.isbn) AS authors=#{authors}, #{publisher},
		 		 #{pub_date}, #{cat_id}, price=#{price})
	</insert>
</mapper>

	




